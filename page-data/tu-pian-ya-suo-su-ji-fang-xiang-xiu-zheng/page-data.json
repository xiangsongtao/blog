{"componentChunkName":"component---src-templates-blog-post-js","path":"/tu-pian-ya-suo-su-ji-fang-xiang-xiu-zheng/","result":{"data":{"site":{"siteMetadata":{"title":"Attila","cover":"/background/1.jpg","description":"Thoughts, stories and ideas.","keywords":["烈风裘的博客","X-Blog","Attila","Gatsby","前端成长记录"],"tagCover":"/background/5.jpg","archiveCover":"/background/escape-flight.png","siteUrl":"https://xiangst0816.github.io/blog","logo":"","navigation":true,"subscribe":true}},"allAuthorJson":{"totalCount":2,"edges":[{"node":{"id":"烈风裘","bio":"一往无前, 直到云开雾散!","avatar":"/avatar/me.jpeg","cover":"/background/photo-1503197979108-c824168d51a8.jpeg","github":"https://github.com/xiangsongtao","twitter":"","zhihu":"","weibo":"","facebook":"","website":"https://xiangsongtao.github.io/blog/","location":"HangZhou, China"}},{"node":{"id":"WALL-E","bio":"还有要清理的吗?","avatar":"/avatar/cleaner.jpg","cover":"","github":null,"twitter":null,"zhihu":null,"weibo":null,"facebook":null,"website":null,"location":"Earth"}}]},"master":{"id":"烈风裘","bio":"一往无前, 直到云开雾散!","avatar":"/avatar/me.jpeg","cover":"/background/photo-1503197979108-c824168d51a8.jpeg","github":"https://github.com/xiangsongtao","twitter":"","zhihu":"","weibo":"","facebook":"","website":"https://xiangsongtao.github.io/blog/","location":"HangZhou, China"},"currentPost":{"html":"<h3 id=\"先描述下问题\" style=\"position:relative;\"><a href=\"#%E5%85%88%E6%8F%8F%E8%BF%B0%E4%B8%8B%E9%97%AE%E9%A2%98\" aria-label=\"先描述下问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>先描述下问题</h3>\n<p>Webapp 在上传图片的时候，会出现旋转 90° 的问题，但是在上传前预览图片是没问题的。这是因为什么呢？</p>\n<p>原因在这边博客中说的很清楚了，<a href=\"https://github.com/xiangpaopao/blog/issues/7\" target=\"_target\" rel=\"nofollow\">查看这里：移动端 Web 上传图片实践</a>。也就是说，对于 IOS 或者上传数码相机拍摄的图片时，为了保证快读读写所以就没对图片进行方向矫正，而是使用一个字段 Orientation 保存方向。故对这种情况需要进行图片方向的纠正。</p>\n<p>这种问题的修复有两种：</p>\n<ul>\n<li>第一种方法是<strong>后台修正</strong>，<a href=\"http://www.graphicsmagick.org/\" target=\"_target\" rel=\"nofollow\">插件 GraphicsMagick</a>提供的 API 比较友好，在控制台输入<code class=\"language-text\">npm install gm</code>进行安装，简单实用如下：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">gm(&#39;/path/to/img.jpg&#39;)\n.autoOrient()\n.resize(240, 240)\n.write(&#39;/path/to/new.jpg&#39;, function (err) {\n  if (err) ...\n})</code></pre></div>\n<ul>\n<li>第二种方法是<strong>前台修正</strong>，可是使用<a href=\"https://github.com/gokercebeci/canvasResize\" target=\"_target\" rel=\"nofollow\">canvasResize 插件</a>，我比较倾向于实用第二种，因为将计算量分布到各个终端，减轻服务器压力。</li>\n</ul>\n<p>主要代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">var file = input.files[0];\ncanvasResize(file, {\n        width: 300,//如果宽度没到300px则不会进行方法处理\n        height: 0,//自适应\n        crop: false,\n        quality: 100,//图片质量，default 80.\n        rotate   : 90,      // Image rotation default 0,如果自动处理则不设置\n        callback: function(data, width, height) {\n            var blob = canvasResize(&#39;dataURLtoBlob&#39;, data);\n            var form = new FormData();\n            form.append(&#39;file&#39;,blob);\n            $.ajax({\n                type: &#39;POST&#39;,\n                url: server,\n                data: form,\n                contentType: false,\n                processData: false,\n            }).done(function (res) {\n                ......\n            }).fail(function () {\n                ......\n            }).always(function () {\n                ......\n            });\n        }\n});</code></pre></div>\n<p>你现在看到的这个博客的所有图片就是采用前台处理的方式进行图片方向矫正及尺寸压缩。<strong>因为使用的 ES6 语法及 VUE 框架，具体代码书写请参我的博客项目</strong>：</p>\n<ul>\n<li>文件<a href=\"https://github.com/xiangsongtao/X-SONGTAO-VUE/blob/master/src/api/api_upload.js\" target=\"_target\" rel=\"nofollow\">api_upload.js</a> 处理上传的公共服务，其中 EXIF.js 和 canvasResize.js 我做了些模块化修改，请移步具体文件。</li>\n<li><a href=\"https://github.com/xiangsongtao/X-SONGTAO-VUE/blob/master/src/views/admin.article.vue\" target=\"_target\" rel=\"nofollow\">HTML 及*.vue 中的使用方法</a>，摘抄如下：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;form action=&quot;&quot; class=&quot;imgUploadForm&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;\n        &lt;input id=&quot;imgUpload&quot; type=&quot;file&quot;&gt;\n&lt;/form&gt;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/**\n * 1. 选择图片,获得filer信息\n * */\n$(&quot;#imgUpload&quot;).change(function (e) {\n    // 文件句柄\n    var file = e.target.files[0];\n    // 只处理图片\n    if (!file.type.match(&#39;image.*&#39;)) {\n        return null;\n    }\n    scope.isImgLoading = true;\n    ImageUpload(file).then(function (imageName) {\n        scope.uploadImgUrl = addImgPrefix(imageName);\n    }, function () {\n        alert(&quot;upload error&quot;);\n    }).then(function () {\n        scope.isImgLoading = false;\n    })\n})</code></pre></div>\n<h3 id=\"介绍下方法二的思路\" style=\"position:relative;\"><a href=\"#%E4%BB%8B%E7%BB%8D%E4%B8%8B%E6%96%B9%E6%B3%95%E4%BA%8C%E7%9A%84%E6%80%9D%E8%B7%AF\" aria-label=\"介绍下方法二的思路 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>介绍下方法二的思路</h3>\n<ol>\n<li>监听 input 的 onChange 事件，获取文件句柄（file）</li>\n<li>传入 file，使用 canvasResize 进行图片尺寸及方向校准，回调得到 base64 编码的图片信息（data）</li>\n<li>将图片改为二进制文件 blob, 准备上传（form）</li>\n<li>将得到的 form 进行上传</li>\n</ol>\n<p>注：上传到后台的文件需要重命名，因为在转成 blob 时，已不是原来文件了。后台相关处理文件<a href=\"https://github.com/xiangsongtao/X-SONGTAO/blob/master/app/routes/api.routes.js\" target=\"_target\" rel=\"nofollow\">请转到这里</a>，Line:84。</p>\n<h3 id=\"最终效果展示\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E7%BB%88%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA\" aria-label=\"最终效果展示 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最终效果展示</h3>\n<blockquote>\n<p>效果还是很明显的，上传速度和未处理基本一样，没感觉。</p>\n</blockquote>\n<h4 id=\"从-iphone-拍摄后未处理的图片手机上看竖着的，pc-上看是横着的\" style=\"position:relative;\"><a href=\"#%E4%BB%8E-iphone-%E6%8B%8D%E6%91%84%E5%90%8E%E6%9C%AA%E5%A4%84%E7%90%86%E7%9A%84%E5%9B%BE%E7%89%87%E6%89%8B%E6%9C%BA%E4%B8%8A%E7%9C%8B%E7%AB%96%E7%9D%80%E7%9A%84%EF%BC%8Cpc-%E4%B8%8A%E7%9C%8B%E6%98%AF%E6%A8%AA%E7%9D%80%E7%9A%84\" aria-label=\"从 iphone 拍摄后未处理的图片手机上看竖着的，pc 上看是横着的 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>从 iphone 拍摄后未处理的图片(手机上看竖着的，pc 上看是横着的)</h4>\n<ul>\n<li>尺寸：3264*2448</li>\n<li>大小 ：1.2MB</li>\n</ul>\n<p><img src=\"http://xiangsongtao.com/uploads/1471425020000.jpg\" alt=\"demo\" title=\"未处理\"></p>\n<hr>\n<h4 id=\"上传前处理后的图片\" style=\"position:relative;\"><a href=\"#%E4%B8%8A%E4%BC%A0%E5%89%8D%E5%A4%84%E7%90%86%E5%90%8E%E7%9A%84%E5%9B%BE%E7%89%87\" aria-label=\"上传前处理后的图片 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>上传前处理后的图片</h4>\n<ul>\n<li>尺寸：710*946</li>\n<li>大小 ：68KB</li>\n</ul>\n<p><img src=\"http://xiangsongtao.com/uploads/1471528805000.jpeg\" title=\"已处理\"></p>\n<h3 id=\"最后\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E5%90%8E\" aria-label=\"最后 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最后</h3>\n<blockquote>\n<p>希望如果有不明白的，请在下方评论或者在 github 提 issue，<a href=\"https://github.com/xiangsongtao/X-SONGTAO-VUE\" target=\"_target\" rel=\"nofollow\">我的博客项目</a>因为还有些小功能未实现，将会一直维护下去，技术问题希望能共同探讨。</p>\n</blockquote>\n<h4 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h4>\n<ul>\n<li><a href=\"https://github.com/xiangpaopao/blog/issues/7\" target=\"_target\" rel=\"nofollow\">移动端 Web 上传图片实践 </a></li>\n<li><a href=\"http://www.graphicsmagick.org/\" target=\"_target\" rel=\"nofollow\">GraphicsMagick</a></li>\n<li><a href=\"https://github.com/gokercebeci/canvasResize\" target=\"_target\" rel=\"nofollow\">canvasResize</a></li>\n</ul>","timeToRead":4,"wordCount":{"paragraphs":32,"sentences":32,"words":127},"fields":{"slug":"/tu-pian-ya-suo-su-ji-fang-xiang-xiu-zheng/","relativePath":"2016/2016-10-20---tu-pian-ya-suo-su-ji-fang-xiang-xiu-zheng/index.md"},"excerpt":"先描述下问题 Webapp 在上传图片的时候，会出现旋转 90° 的问题，但是在上传前预览图片是没问题的。这是因为什么呢？ 原因在这边博客中说的很清楚了，查看这里：移动端 Web 上传图片实践。也就是说，对于 IOS…","frontmatter":{"title":"图片压缩及方向修正","date":"20 Oct 2016","tags":["图片压缩","图片修正"],"cover":"","comments":true,"author":"烈风裘"}},"nextPost":{"html":"<p>记得很早之前就对正则进行了简单的学习，我自己在下面也总结了很多次，但是一到用的时候就懵逼了。看来还是实践较少的结果。今天特此花时间在总结下，并且附上常用的正则示例。</p>\n<h2 id=\"思维导图：\" style=\"position:relative;\"><a href=\"#%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%EF%BC%9A\" aria-label=\"思维导图： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>思维导图：</h2>\n<p><img src=\"http://xiangsongtao.com/uploads/1474687442000.png\" alt=\"正则\" title=\"正则\"></p>\n<h2 id=\"常用示例：\" style=\"position:relative;\"><a href=\"#%E5%B8%B8%E7%94%A8%E7%A4%BA%E4%BE%8B%EF%BC%9A\" aria-label=\"常用示例： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>常用示例：</h2>\n<h3 id=\"去除首位空格（单独去除左右空格类似）：\" style=\"position:relative;\"><a href=\"#%E5%8E%BB%E9%99%A4%E9%A6%96%E4%BD%8D%E7%A9%BA%E6%A0%BC%EF%BC%88%E5%8D%95%E7%8B%AC%E5%8E%BB%E9%99%A4%E5%B7%A6%E5%8F%B3%E7%A9%BA%E6%A0%BC%E7%B1%BB%E4%BC%BC%EF%BC%89%EF%BC%9A\" aria-label=\"去除首位空格（单独去除左右空格类似）： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>去除首位空格（单独去除左右空格类似）：</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;   ac f    &quot;.replace(/(^\\s*)|(\\s*$)/g,&#39;&#39;)</code></pre></div>\n<h3 id=\"v-err-src转化为驼峰名字verrsrc：\" style=\"position:relative;\"><a href=\"#v-err-src%E8%BD%AC%E5%8C%96%E4%B8%BA%E9%A9%BC%E5%B3%B0%E5%90%8D%E5%AD%97verrsrc%EF%BC%9A\" aria-label=\"v err src转化为驼峰名字verrsrc： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>“v-err-src”转化为驼峰名字”vErrSrc”：</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&#39;v-err-src&#39;.replace(/-(\\w)/ig,function(x){\n   return x.slice(1).toUpperCase()\n})</code></pre></div>\n<h3 id=\"xxx-xxxx-xxxxx-前三位数字开头，中间四位字母开头数字结尾，后-5-位随意：\" style=\"position:relative;\"><a href=\"#xxx-xxxx-xxxxx-%E5%89%8D%E4%B8%89%E4%BD%8D%E6%95%B0%E5%AD%97%E5%BC%80%E5%A4%B4%EF%BC%8C%E4%B8%AD%E9%97%B4%E5%9B%9B%E4%BD%8D%E5%AD%97%E6%AF%8D%E5%BC%80%E5%A4%B4%E6%95%B0%E5%AD%97%E7%BB%93%E5%B0%BE%EF%BC%8C%E5%90%8E-5-%E4%BD%8D%E9%9A%8F%E6%84%8F%EF%BC%9A\" aria-label=\"xxx xxxx xxxxx 前三位数字开头，中间四位字母开头数字结尾，后 5 位随意： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>xxx-xxxx-xxxxx, 前三位数字开头，中间四位字母开头数字结尾，后 5 位随意：</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/^\\d\\w{2}-[a-zA-Z]\\d{3}-.{5}$/.test(&#39;1as-a234-wwwww&#39;)</code></pre></div>\n<h3 id=\"邮箱验证：\" style=\"position:relative;\"><a href=\"#%E9%82%AE%E7%AE%B1%E9%AA%8C%E8%AF%81%EF%BC%9A\" aria-label=\"邮箱验证： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>邮箱验证：</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/^\\w+@[1-9a-z]+(\\.[a-z]+){1,3}$/.test(&quot;xxxx@16.cn.net&quot;)</code></pre></div>\n<h3 id=\"中文范围：\" style=\"position:relative;\"><a href=\"#%E4%B8%AD%E6%96%87%E8%8C%83%E5%9B%B4%EF%BC%9A\" aria-label=\"中文范围： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>中文范围：</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">匹配中文：[\\u4e00-\\u9fa5] //中文ACALL码的范围</code></pre></div>\n<p>以上就差不多这些了！</p>","timeToRead":2,"wordCount":{"paragraphs":10,"sentences":10,"words":23},"fields":{"slug":"/zheng-ze-jian-dan-shan-chan-zong-jie/","relativePath":"2016/2016-10-20---zheng-ze-jian-dan-shan-chan-zong-jie/index.md"},"excerpt":"…","frontmatter":{"title":"正则简单总结","date":"20 Oct 2016","tags":["正则","JavaScript"],"cover":"","comments":true,"author":"烈风裘"}},"prevPost":{"html":"<p>浏览器缓存机制一般分为两种：HTML Meta 标签控制缓存和 <strong>HTTP 头信息</strong>。</p>\n<h2 id=\"html-meta-标签控制缓存\" style=\"position:relative;\"><a href=\"#html-meta-%E6%A0%87%E7%AD%BE%E6%8E%A7%E5%88%B6%E7%BC%93%E5%AD%98\" aria-label=\"html meta 标签控制缓存 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTML Meta 标签控制缓存</h2>\n<p>非 HTTP 协议定义的缓存机制，如使用 HTML Meta 标签，Web 开发者可以在 HTML 页面的<head>节点中加入<meta>标签，代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">＜meta http-equiv=\"参数\" content=\"参数变量值\"＞</code></pre></div>\n<p><strong>参数可以是以下值：</strong></p>\n<p>expires(期限) 、Pragma(cache 模式)、Refresh(刷新) 、\nSet-Cookie(cookie 设定) 、Window-target(显示窗口的设定) 、\ncontent-Type(显示字符集的设定) 、Pics-label(网页等级评定) 、\ncache-control 等。</p>\n<p><a href=\"http://kinglyhum.iteye.com/blog/827807\" target=\"_target\" rel=\"nofollow\">设置请参考这里</a></p>\n<p>但是，所有缓存代理服务器都不支持上述方法，因为代理不解析 HTML 内容本身。而广泛应用的还是 <strong>HTTP 头信息</strong> 来控制缓存，下面主要介绍 HTTP 协议定义的缓存机制，这个是比较通用的做法。记住相应的参数、作用及设置方法，就差不多了。</p>\n<h2 id=\"http-头信息控制缓存\" style=\"position:relative;\"><a href=\"#http-%E5%A4%B4%E4%BF%A1%E6%81%AF%E6%8E%A7%E5%88%B6%E7%BC%93%E5%AD%98\" aria-label=\"http 头信息控制缓存 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTP 头信息控制缓存</h2>\n<h3 id=\"资源新鲜度检测（freshness）\" style=\"position:relative;\"><a href=\"#%E8%B5%84%E6%BA%90%E6%96%B0%E9%B2%9C%E5%BA%A6%E6%A3%80%E6%B5%8B%EF%BC%88freshness%EF%BC%89\" aria-label=\"资源新鲜度检测（freshness） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>资源新鲜度检测（Freshness）</h3>\n<p><code class=\"language-text\">Cache Control</code>与<code class=\"language-text\">Expires</code>是一组，他们是用来进行 Freshness 验证，也就是提供客户端检测文件是否足够新鲜，可以无需向服务端发起 Validation 请求(见下)就能保证并未过期可以直接使用。</p>\n<p>所有的<code class=\"language-text\">(from cache)</code>的请求实际上都是由于浏览器认为本地的缓存资源足够新鲜，所以无需额外请求而直接使用。实际上就是根据本地的时间和服务器返回头的约定信息进行对比验证。</p>\n<h4 id=\"expires\" style=\"position:relative;\"><a href=\"#expires\" aria-label=\"expires permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Expires</h4>\n<p>在 HTTP1.0 版本中定义的是<code class=\"language-text\">Expires</code>，<code class=\"language-text\">Expires</code>的值是一个明确的<strong>GMT 格式</strong>的过期时间，指浏览器或缓存服务器在该时间点后必须从真正的服务器中获取新的页面信息；<mark>当用户的时间和服务器时间不一致的手，会引发缓存判断的问题</mark>（例如客户端的本地时间错误）。如果不设置缓存，需要将<code class=\"language-text\">Expires</code>设为 0；</p>\n<h4 id=\"cache-control\" style=\"position:relative;\"><a href=\"#cache-control\" aria-label=\"cache control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache Control</h4>\n<p>因此，在 HTTP1.1 版本中再追加判断字段：<code class=\"language-text\">Cache-Control</code>。<strong>其中<code class=\"language-text\">max-age</code>参数告知客户端这个文件多长时间不会过期</strong>而不是直接告知过期时间。常用的参数如下：</p>\n<ul>\n<li>no-cache：浏览器和缓存服务器都不应该缓存页面信息；</li>\n<li>private：只在内存中缓存, 默认；</li>\n<li>no-store：请求和响应的信息都不应该被存储在对方的磁盘系统中；</li>\n<li>must-revalidate：对于客户机的每次请求，代理服务器必须向服务器验证缓存是否过时；</li>\n<li>public, max-age=[number]：在硬盘中缓存, 浏览器和缓存服务器都可以缓存页面信息，并设定具体的过期秒数</li>\n</ul>\n<blockquote>\n<p>以上两个如果同时存在，则<code class=\"language-text\">Cache Control</code>的<code class=\"language-text\">max-age</code>将覆盖<code class=\"language-text\">Expires</code>.</p>\n</blockquote>\n<h3 id=\"资源验证（validation）\" style=\"position:relative;\"><a href=\"#%E8%B5%84%E6%BA%90%E9%AA%8C%E8%AF%81%EF%BC%88validation%EF%BC%89\" aria-label=\"资源验证（validation） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>资源验证（Validation）</h3>\n<p><code class=\"language-text\">Last-Modified</code>和<code class=\"language-text\">ETag</code>则是另一组控制信息，他们用来实现 Validation。他们的职责是在本地缓存被浏览器判断可能不够新鲜的时候，会用这两组信息向服务器请求数据，如果服务器内容没有改变，那么约定服务器会返回 <strong>304(Not Modify)</strong> HTTP Code 表明这个缓存可以直接使用，无需重新拉取，而一旦服务器内容改变了就会返回 <strong>200(from cache)</strong>，同时返回新的文件内容。</p>\n<h4 id=\"last-modified\" style=\"position:relative;\"><a href=\"#last-modified\" aria-label=\"last modified permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Last-Modified</h4>\n<p>在 HTTP 1.0 中约定的<code class=\"language-text\">Last-Modified</code>代表的含义是文件最后一次修改的<strong>GMT 格式</strong>的时间，但是当访问的静态资源师动态生成的，<strong>比如动态 gzip 压缩 js/css 代码，那么返回的<code class=\"language-text\">Last-Modified</code>每次都会不一样</strong>；另外<code class=\"language-text\">Last-Modified</code>只能精确到秒，如果文件变动在秒以内，则客户端无法感知。</p>\n<p>如果用户第二次打开，在请求头上会添加<code class=\"language-text\">If-Modified-Since</code>关键字，传递本地缓存的资源最后修改时间<code class=\"language-text\">Last-Modified</code>，之后由服务器判断是返回 304 NotModified 还是 200 OK(新资源)</p>\n<h4 id=\"etag\" style=\"position:relative;\"><a href=\"#etag\" aria-label=\"etag permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ETag</h4>\n<p>因此，在 HTTP1.1 版本中再追加判断字段：<code class=\"language-text\">ETag</code>。他的实现不尽相同，对于<strong>动态内容</strong>，常规做法是对动态内容做 HASH 计算，作为 ETAG 返回，对于静态资源，一般是使用 inode+mtime 进行计算。</p>\n<p>同样，如果之前设置了此值，当用户第二次打开时，请求头会携带<code class=\"language-text\">If-None-Match</code>关键字，判断资源的<code class=\"language-text\">ETag</code>是否过期。</p>\n<p>ETag 也有他自己的问题，所以经常在使用中会关闭<code class=\"language-text\">ETag</code>。举例来说，同一个文件在不同物理机上的 inode 是不同的，这就导致了在分布式的 Web 系统中，当访问落在不同的物理机上时会返回不同的<code class=\"language-text\">ETag</code>，进而导致 304 失效，降级为 200 请求。解决办法也有从<code class=\"language-text\">ETag</code>算法中剥离 inode，只是使用 mtime，但是这样实际上和<code class=\"language-text\">Last-Modified</code>就一样了。当然你也可以额外的做一些改进，使<code class=\"language-text\">ETag</code>对静态资源的算法也是通过 hash 计算的。不过由于一般我们会使用 CDN 技术，因此集群部署中的<code class=\"language-text\">ETag</code>问题并不会造成太大的影响，所以折腾的人也不太是很多。</p>\n<h3 id=\"nodejs--express-处理方式\" style=\"position:relative;\"><a href=\"#nodejs--express-%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F\" aria-label=\"nodejs  express 处理方式 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nodejs + Express 处理方式</h3>\n<h4 id=\"静态资源处理\" style=\"position:relative;\"><a href=\"#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86\" aria-label=\"静态资源处理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>静态资源处理</h4>\n<ul>\n<li>设置 30 天后过期</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\n  express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    etag<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//资源标记</span>\n    maxAge<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//除去下面格式的其余文件不缓存，比如html</span>\n    <span class=\"token function-variable function\">setHeaders</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> state</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token regex\">/\\.(js|css|png|gif|jpg|jpeg)$/</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 未来的一个过期时间</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Expires\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">2592000</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toGMTString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cache-Control\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"public, max-age=2592000\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>不缓存</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'public'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    etag<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//资源标记</span>\n    maxAge<span class=\"token operator\">:</span> <span class=\"token number\">0</span>，\n    <span class=\"token function-variable function\">setHeaders</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">res<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> state</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\.(js|css|png|gif|jpg|jpeg)$/</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Expires'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Cache-Control'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"缓存策略根据不同的重新浏览方式分为以下几种情况\" style=\"position:relative;\"><a href=\"#%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E6%A0%B9%E6%8D%AE%E4%B8%8D%E5%90%8C%E7%9A%84%E9%87%8D%E6%96%B0%E6%B5%8F%E8%A7%88%E6%96%B9%E5%BC%8F%E5%88%86%E4%B8%BA%E4%BB%A5%E4%B8%8B%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5\" aria-label=\"缓存策略根据不同的重新浏览方式分为以下几种情况 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>缓存策略根据不同的重新浏览方式分为以下几种情况</h3>\n<ul>\n<li>\n<p>打开新窗口</p>\n<p>如果指定 cache-control 的值为 private、no-cache、must-revalidate，那么打开新窗口访问时都会重新访问服务器。而如果指定了 max-age 值，那么在此值内的时间里就不会重新访问服务器，例如：</p>\n<p>Cache-control: max-age=5\n表示当访问此网页后的 5 秒内再次访问不会去服务器获取资源</p>\n</li>\n<li>\n<p>在地址栏回车</p>\n<p>如果值为 private 或 must-revalidate（和网上说的不一样），则只有第一次访问时会访问服务器，以后就不再访问。如果值为 no-cache，那么每次都会访问。如果值为 max-age，则在过期之前不会重复访问。</p>\n</li>\n<li>\n<p>按后退按扭</p>\n<p>如果值为 private、must-revalidate、max-age，则不会重新访问，而如果为 no-cache，则每次都重复访问</p>\n</li>\n<li>\n<p>按刷新按扭</p>\n<p>无论为何值，都会重复访问</p>\n</li>\n</ul>\n<h3 id=\"总结一下\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B\" aria-label=\"总结一下 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结一下</h3>\n<p><code class=\"language-text\">ETag</code>的设置并不会影响 Freshness 验证，Freshness 验证只会和浏览器策略、<code class=\"language-text\">Cache Control</code>、<code class=\"language-text\">Expires</code>有关。</p>\n<p>也就是说，如果访问的静态资源并不会存在小于 1s 的求改情况，<code class=\"language-text\">ETag</code>可以关闭。</p>\n<p>下面是上述文字的整个流程图：</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 472px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 109.52380952380953%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAAD4ElEQVQ4y42UW0hcVxSGz5lMICmhD32SUtMWkjSJJKJGaaQ3ShvoY9K3ICUPfShSYsDSBxMkfRQ1rTZtodAHcR7qeEcU8X7HGypateL9ftcZdcYZz5zZ/dZhZhBJmWxY7H32Xus/61/r31sbHBzUZGRlZdnW19e/3t3dzVhaWkpfW1tL39vbe7KwsJAk56Zp6g0NDVrUQbBN5oqKirc3NjZ8igGw2t/fl6Wam5tzyjlLO+BWjNfr1V5rZGdnxzqdzsS8vLyUwsLCpKKiooS4uLg3TvtEBTs+Pr5MZp+3tLR83NbWltzf33+ruLj4s/r6+tSxsbHb0LyLfQLQR263+5LETE5O6jMzMzYytmxxcdE2Oztra29v1zTDMH4SakLx6OhIHRwcKPZUIBBQ/MzaB8ii7/P54qPS9Hg8WeJMsI91gDlweHhomXxjBmYCfOz3+1Nx1WFyaX5+PmV1dTV1ZWXlLjVP5fvDrq6uiwL4lA4qDv0jIyMm6Zs4BAEOQs2cmpoyAVIEujY3Nxeg2kRZsoXB1taWxSrMAN90AXwmHzs7OyYyUcjGcoKekm+hHKJuEHgf4Jjy8vL3Ghsbv29qaspobW19TP0zmpubHzscjliNv/8ogBTdhXkA8hK8QvC2rBlH/NQLqJvaXotaQ5fL9RaBNwH+gKAbYL9P1/+CTgbrWPZuAnSd+SplucCeRjZ6T0/PObG+vj7Lent77VVVVforf0Idny8vL9971RkN0QYGBnTqa5uYmLDm8fFxm+xHBlJ5hwySyDKeWt5C4In5+fkJZHYbyvHUNIHavim+6FP/P7bha6ydnJz8KnWkcz5pDhkqrmRQpMO2ETr7NBxIhjGcX8PvCk26QuevlpSUXIggk8lLCSJDY3t7W0FDoXyr42Qo5mddRRmm6ep3PBwoaNO689TVUgRnztOAVoZk6sfRFCPIBMTkLCA6pevfABBfVlZ2GZn80NnZ+RJ70dHR8aK7u/v3mpqar04D/hbOEJoKMEX3rWsYyjCAJh1k8ycPRjLnf7OeZB4SI4F/UcUfEUAyKwzdVS9ABrVxIx0PWRnsGZz72P8FWs8QddzQ0JADG+Vm9Q0PD/eOjo7+w/rnCCBdjEW8Kcx3CEykjt/y1wcAJgCWRIbJ2usOEerZQedKsLSz+9A7X11drcsDIXFnTLfb7RFQneKe48WQDL+g2A+h9AAJfTk9Pf2u+NAgS3/UTisoKNBKS0s1pKLxIFtzTk5ORFOWY2VlZQw0T4LBoJLGyAMhA4DS0E9ttbW10Snn5uaGlzoFv0fQo7q6ujRuRBrzI16QG3KINLTMzMyoeP8B6PjYxiD3rI0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"流程图\"\n        title=\"流程图\"\n        src=\"/blog/static/b65e46de39a67256740c7fd77f31e2a2/49211/1476065346000.png\"\n        srcset=\"/blog/static/b65e46de39a67256740c7fd77f31e2a2/e1650/1476065346000.png 210w,\n/blog/static/b65e46de39a67256740c7fd77f31e2a2/8cae7/1476065346000.png 420w,\n/blog/static/b65e46de39a67256740c7fd77f31e2a2/49211/1476065346000.png 472w\"\n        sizes=\"(max-width: 472px) 100vw, 472px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">流程图</figcaption>\n  </figure></p>\n<p><strong>说明点:</strong></p>\n<ul>\n<li>当 freshness 检查失败，则发送资源请求并携带 ETage 和 Last-Modified 信息</li>\n<li>ETag 和 Last-Modified 都会发送给服务器不分前后</li>\n<li>Etag 用于动态内容会比 Last-Modified 好</li>\n</ul>\n<h3 id=\"参考文章\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0\" aria-label=\"参考文章 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考文章</h3>\n<ul>\n<li><a href=\"http://www.cnblogs.com/liuling/archive/2013/07/25/2013-7-25-01.html\" target=\"_target\" rel=\"nofollow\">页面的缓存与不缓存设置</a></li>\n<li><a href=\"http://div.io/topic/854#4091\" target=\"_target\" rel=\"nofollow\">配置错误产生的差距：200 OK (FROM CACHE) 与 304 NOT MODIFIED</a></li>\n<li><a href=\"http://www.cnblogs.com/cuixiping/archive/2008/05/04/1181056.html\" target=\"_target\" rel=\"nofollow\">“Cache-control”常见的取值</a></li>\n<li><a href=\"http://kinglyhum.iteye.com/blog/827807\" target=\"_target\" rel=\"nofollow\">Meta http-equiv 属性详解</a></li>\n<li><a href=\"https://my.oschina.net/leejun2005/blog/369148\" target=\"_target\" rel=\"nofollow\">浏览器 HTTP 协议缓存机制详解</a></li>\n</ul>","timeToRead":8,"wordCount":{"paragraphs":59,"sentences":59,"words":334},"fields":{"slug":"/ye-mian-huan-cun-she-zhi/","relativePath":"2016/2016-10-22---ye-mian-huan-cun-she-zhi/index.md"},"excerpt":"浏览器缓存机制一般分为两种：HTML Meta 标签控制缓存和 HTTP 头信息。 HTML Meta 标签控制缓存 非 HTTP 协议定义的缓存机制，如使用 HTML Meta 标签，Web 开发者可以在 HTML…","frontmatter":{"title":"页面缓存设置","date":"22 Oct 2016","tags":["缓存"],"cover":"","comments":true,"author":"烈风裘"}}},"pageContext":{"curr":"/tu-pian-ya-suo-su-ji-fang-xiang-xiu-zheng/","prev":"/ye-mian-huan-cun-she-zhi/","next":"/zheng-ze-jian-dan-shan-chan-zong-jie/"}},"staticQueryHashes":["3240721340","63159454"]}