{"componentChunkName":"component---src-templates-blog-post-js","path":"/js-gao-cheng-wen-da/","result":{"data":{"site":{"siteMetadata":{"title":"Attila","cover":"/background/1.jpg","description":"Thoughts, stories and ideas.","keywords":["烈风裘的博客","X-Blog","Attila","Gatsby","前端成长记录"],"tagCover":"/background/5.jpg","archiveCover":"/background/escape-flight.png","siteUrl":"https://xiangst0816.github.io/blog","logo":"","navigation":true,"subscribe":true}},"allAuthorJson":{"totalCount":2,"edges":[{"node":{"id":"烈风裘","bio":"一往无前, 直到云开雾散!","avatar":"/avatar/avatar.jpeg","cover":"/background/photo-1503197979108-c824168d51a8.jpeg","github":"https://github.com/xiangst0816","twitter":"","zhihu":"","weibo":"","facebook":"","website":"https://xiangst0816.github.io/blog/","location":"HangZhou, China"}},{"node":{"id":"WALL-E","bio":"还有要清理的吗?","avatar":"/avatar/cleaner.jpg","cover":"","github":null,"twitter":null,"zhihu":null,"weibo":null,"facebook":null,"website":null,"location":"Earth"}}]},"master":{"id":"烈风裘","bio":"一往无前, 直到云开雾散!","avatar":"/avatar/avatar.jpeg","cover":"/background/photo-1503197979108-c824168d51a8.jpeg","github":"https://github.com/xiangst0816","twitter":"","zhihu":"","weibo":"","facebook":"","website":"https://xiangst0816.github.io/blog/","location":"HangZhou, China"},"currentPost":{"html":"<h2 id=\"缘由\" style=\"position:relative;\"><a href=\"#%E7%BC%98%E7%94%B1\" aria-label=\"缘由 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>缘由</h2>\n<p>记得第一次看《JavaScript 高级程序设计》这本书是在两年前刚接触前端，花了一点时间大致翻阅了下，随后就把这本书当做工具书来用。工作两年后，虽然面对的业务千奇百怪但都能查查手册 Cover 住，但是深究起来就不知所以，比如：</p>\n<blockquote>\n<p>函数执行时内部会有哪些操作？<br>\n顺便讲讲其中涉及的闭包、变量提升、作用域链？</p>\n</blockquote>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAFA3PEY8MlBGQUZaVVBfeMiCeG5uePWvuZHI////////////////////////////////////////////////////2wBDAVVaWnhpeOuCguv/////////////////////////////////////////////////////////////////////////wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBP/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAbish6Qn/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQAv/aAAgBAQABBQJic1f/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAQIVH/2gAIAQEAAT8hNKdqyBHor//aAAwDAQACAAMAAAAQ+8//xAAWEQADAAAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8QgX//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAACAwEBAAAAAAAAAAAAAAABEQAQYSEx/9oACAEBAAE/EFSTiNE0bWwGeXpr/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JS高程\"\n        title=\"JS高程\"\n        src=\"/blog/static/a7bb8ebc409f3c935ae73d97f206b4e1/040f2/book.jpg\"\n        srcset=\"/blog/static/a7bb8ebc409f3c935ae73d97f206b4e1/58c35/book.jpg 210w,\n/blog/static/a7bb8ebc409f3c935ae73d97f206b4e1/0d24e/book.jpg 420w,\n/blog/static/a7bb8ebc409f3c935ae73d97f206b4e1/040f2/book.jpg 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">JS高程</figcaption>\n  </figure></p>\n<p>作为两年前端再搞不明白，那真是惭愧。</p>\n<p>最近抽了工作之余和下班之余重新翻看，为了避免枯燥我就以问答的形式总结，把书中的问题和我自己遇到的问题按照书中章节归类。其中较为基础或者冷门的部分我就不再重述。</p>\n<h2 id=\"目录\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E5%BD%95\" aria-label=\"目录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目录</h2>\n<ul>\n<li>第一章 JavaScript 介绍</li>\n<li>第二章 在 HTML 中使用 JavaScript</li>\n<li>第三章 基本概念</li>\n<li><a href=\"/blog/di-si-zhang-bian-liang/\">第四章 变量-作用域和内存问题</a></li>\n<li><a href=\"/blog/di-wu-zhang-yin-yong-lei-xing/\">第五章 引用类型</a></li>\n<li><a href=\"/blog/di-liu-lu-zhang-mian-xiang-dui-xiang/\">第六章 面相对象的程序设计</a></li>\n<li><a href=\"/blog/di-qi-zhang-han-shu-shuo-biao-da-shi/\">第七章 函数表达式</a></li>\n<li><a href=\"/blog/di-ba-zhang-BOM/\">第八章 BOM</a></li>\n<li><a href=\"/blog/di-jiu-zhang-ke-hu-duan-jian-ce/\">第九章 客户端检测</a></li>\n<li><a href=\"/blog/di-shi-zhang-DOM/\">第十章 DOM</a></li>\n<li><a href=\"/blog/di-shi-yi-zhang-DOM-tuo-ta-zhi-zhan/\">第十一章 DOM 拓展</a></li>\n<li><a href=\"/blog/di-shi-er-zhang-DOM2-he-huo-hu-DOM3/\">第十二章 DOM2 和 DOM3</a></li>\n<li><a href=\"/blog/di-shi-san-zhang-shi-jian/\">第十三章 事件</a></li>\n<li>第十四章 表单脚本</li>\n<li>第十五章 使用 Canvas 绘图</li>\n<li>第十六章 HTML5 脚本编程</li>\n<li><a href=\"/blog/di-shi-qi-zhang-cuo/\">第十七章 错误处理及调试</a></li>\n<li>第十八章 JavaScript 与 XML</li>\n<li>第十九章 E4X</li>\n<li><a href=\"/blog/di-20-zhang-json/\">第二十章 JSON</a></li>\n<li><a href=\"/blog/di-er-shi-yi-zhang/\">第二十一章 Ajax 与 Comet</a></li>\n<li><a href=\"/blog/di-er-shi-er-zhang/\">第二十二章 高级技巧</a></li>\n<li><a href=\"/blog/di-er-shi-san-zhang/\">第二十三章 离线应用与客户端存储</a></li>\n<li>第二十四章 最佳实践</li>\n<li>第二十五章 新兴的 API</li>\n</ul>\n<h2 id=\"其他\" style=\"position:relative;\"><a href=\"#%E5%85%B6%E4%BB%96\" aria-label=\"其他 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>其他</h2>\n<p>如果文章中有错误的表述，可以从文章 Title 下方的 Github 进入页面原文提交 PR，谢谢了！</p>","timeToRead":2,"wordCount":{"paragraphs":34,"sentences":34,"words":99},"fields":{"slug":"/js-gao-cheng-wen-da/","relativePath":"2018/2018-03-27---js-gao-cheng-wen-da/index.md"},"excerpt":"缘由 记得第一次看《JavaScript 高级程序设计》这本书是在两年前刚接触前端，花了一点时间大致翻阅了下，随后就把这本书当做工具书来用。工作两年后，虽然面对的业务千奇百怪但都能查查手册 Cover…","frontmatter":{"title":"JS高程问答","date":"27 Mar 2018","tags":["JS高程"],"cover":"","comments":true,"author":"烈风裘"}},"nextPost":{"html":"<blockquote>\n<p>这里所指都是在浏览器环境中，而不是 Nodejs 环境。</p>\n</blockquote>\n<h2 id=\"js-异步机制\" style=\"position:relative;\"><a href=\"#js-%E5%BC%82%E6%AD%A5%E6%9C%BA%E5%88%B6\" aria-label=\"js 异步机制 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JS 异步机制</h2>\n<blockquote>\n<p>关于 JS 简要的运行机制及事件队列等知识<strong>强烈</strong>希望能翻墙看下这个视频：<a href=\"https://www.youtube.com/watch?v=8aGhZQkoFbQ\" target=\"_target\" rel=\"nofollow\">地址</a>。</p>\n</blockquote>\n<p>这里有个很重要的图需要深刻理解：</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACJElEQVQoz21STW/TQBDN3+KKUIXgUnHgX8CVQ6VegAMS4lJKUQ9QDhw4ViKIgrggQJQkTQOUKCEf5KP5cBzXXnvtXa/tx+y6DQ1gabSjGb+3b+dNoXRYQrVWQeloH5trN1F8tIZa/QDlahnv9/fwufwWFepXDr8solzNo0LY0ulZ/VomnjIKgWCI0xBh4uPZjy20Bs+hEg4F4Ki5g05vl/IMUcwgqS7ojJMAKuWQykcoGfUC09NRCKWPBIJ+EEizEClixJnAzBnDZRPY7hizk5H5WVEvpYuciGPkzCEp1xXd0xw6FoRapTAgAUm5T3UuA6oDQiUEVFBBH7N3d9Et3ka7eAfj1+vgnTeGVJEYlUU5YXqOMCeP0LEG6LtdsKCIufsCTEaYtj6iuXERjY0VNB5eRv3+BdifNgkDMwJDGMXLCpMsl24Pe/A8m56+jsHoBnwlwac1HD+5gp/bq6hvXcNw+xLcg6dm3sn/COVCIcfcphklAo73mEgf0FwjMsuDdBvwJt/BpnXEbhOCj83ME0TnCeUSoW6w8ARzz4JFhlhkUEJO66fpzxcCPOYm12RawBnuX4VUJN9I2YyILDisTU5/o16H1qNNq9IC4y1w4RsjNEZj/yJcVqiX4Xjaw3TO4Lj30O2toD9cpbiOX/2rmFi3SC/NDTnZGeHp2rA/pqjAnPomL7BJCa2OKFG+S/krij14/CX88ANdLsnEwGDMjmb5DH8DVRozD2fPyKoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Chrome中JS运行机制\"\n        title=\"Chrome中JS运行机制\"\n        src=\"/blog/static/81273561d5de2c2910bbea2112432038/f88f5/js-in-chrome.png\"\n        srcset=\"/blog/static/81273561d5de2c2910bbea2112432038/e1650/js-in-chrome.png 210w,\n/blog/static/81273561d5de2c2910bbea2112432038/8cae7/js-in-chrome.png 420w,\n/blog/static/81273561d5de2c2910bbea2112432038/f88f5/js-in-chrome.png 840w,\n/blog/static/81273561d5de2c2910bbea2112432038/a4e06/js-in-chrome.png 1023w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Chrome中JS运行机制</figcaption>\n  </figure></p>\n<ul>\n<li>Chrome 中的 V8 只处理 JS 的解析及执行（可能有歧义）</li>\n<li>JS 运行在单线程上，通过 event loop 完成异步调度</li>\n<li>DOM、XMLHTTPREquest、setTimeout、setInterval 等是异步的 WebAPIs</li>\n<li>异步代码会被推入 callback queue（Tasks）中，当 stack 空闲时挨个推入 stack</li>\n<li>PS: microtasks 稍后介绍</li>\n</ul>\n<p>这里是 Video 中关于执行一个异步操作时的图示：</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACJUlEQVQoz31SO2/TUBT2n2JGQkL8Aub+BUYWJNgYECoMTAUhdUAUQZSkSZMWBiTUoRBEUprGCAGJ49pxcm1f+/r9+Di+TlAZYPh8Hj73nO88lKc372Lv/g4674/Q6rax32+ie9hB/10P7d4+Wgdt9I+66JFv781LNFqv13aX4pvYfbGLRruB3tsD6VeWx9/h6wwJcsR5hLwMUSIDUBBy0iq9lHZBUZB2vvaVSBHTd2PnUHxyuKkPbbWEyRgsk2HFdFjODFw4EIlAVkRULEBWBkiLAAnZZvMW1AdXMHt0FYtX13BxvIU4sqF4kYcscRAKEwk9SsuYOIRUKyQ7RJgFxDqiZCkxLCVS0t3BM1jd27A6d+Ce3IPz8wnShEPRuAfNC6BxH1Obk7QwdXXMOYNO/mXgyVZs7xCGtQ2LPUYYf77UdD2cCikVVgzuQtUNzJiNhRAwfReG75DukS7AY18+Yu5D/Ph1HdrFDfhhk8ZA0yyou0LUkOMIoXB/heFoAGuly4GXcsiJlAW1XSCiwAQi+gDd3MHSfo4oPSNfTowCySorI5lMMqTdIs4EtZBQulj+zP4ERXKOlm1Qy7Q40wbjsWRcJbgcu4FS/WDuAroxhUtsqwKyWgVaUlWMC0asOOmeRJILWahaYo1aly1v7o0a+Ou+NogpaG7N1/dX/Af1fSqT0wFUwrevlfyEyaiGWsnhR5wTxl9OMD4f4mwy+ifG6ggT9RS/AV4BMhEAn1UeAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"JS运行时\"\n        title=\"JS运行时\"\n        src=\"/blog/static/5be09d41c91a9c861541a681bb601c7d/f88f5/js-run.png\"\n        srcset=\"/blog/static/5be09d41c91a9c861541a681bb601c7d/e1650/js-run.png 210w,\n/blog/static/5be09d41c91a9c861541a681bb601c7d/8cae7/js-run.png 420w,\n/blog/static/5be09d41c91a9c861541a681bb601c7d/f88f5/js-run.png 840w,\n/blog/static/5be09d41c91a9c861541a681bb601c7d/57a2b/js-run.png 1260w,\n/blog/static/5be09d41c91a9c861541a681bb601c7d/b5d14/js-run.png 1680w,\n/blog/static/5be09d41c91a9c861541a681bb601c7d/1bf6b/js-run.png 2561w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">JS运行时</figcaption>\n  </figure></p>\n<ul>\n<li>当浏览器开始执行我们的代码时，会将 Script 推入 Tasks 中（就是<code class=\"language-text\">&lt;script&gt;</code>中的代码）</li>\n<li>当 stack 为空，则 event loop 从 task queue 中取出一个任务执行</li>\n<li>运行代码打印<code class=\"language-text\">Hi</code></li>\n<li>遇到<code class=\"language-text\">setTimeout</code>时，将回调推入 webapis 管理（里面有一个定时队列）</li>\n<li>代码继续向下执行，输出<code class=\"language-text\">JSConfEU</code>，随后 stack 清空，<strong>UI 刷新</strong></li>\n<li>当定时时间到了，webapis 将回调推入 task queue 中，stack 此时为空，event loop 取一个任务推入 stack 执行</li>\n<li>代码输出<code class=\"language-text\">there</code></li>\n</ul>\n<p>以上就是 JS 的异步执行过程，<strong>Tasks</strong>就是上图中的 task queue，<strong>microtasks</strong>在下面介绍。</p>\n<h2 id=\"tasksmicrotasks-的区别\" style=\"position:relative;\"><a href=\"#tasksmicrotasks-%E7%9A%84%E5%8C%BA%E5%88%AB\" aria-label=\"tasksmicrotasks 的区别 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tasks/microtasks 的区别</h2>\n<p>Google Chrome 的开发者 Jake 对存在 microtasks 时的情况有篇博文介绍的很详细，<a href=\"https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\" target=\"_target\" rel=\"nofollow\">地址</a>，建议精读。以下通过代码解读用于区别 Tasks 和 microtasks。</p>\n<h3 id=\"代码解读-1\" style=\"position:relative;\"><a href=\"#%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB-1\" aria-label=\"代码解读 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>代码解读 1:</h3>\n<p>当<code class=\"language-text\">setTimeout</code>和<code class=\"language-text\">Promise</code>同时存在时，代码示例及执行顺序说明如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script start\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setTimeout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>下图中需要重点理解 Tasks、Microtasks、JS stack 这三个栈</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 681px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.38095238095238%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+UlEQVQ4y5XSXW/SUBgH8PNBJhdQoC0M2RjtCpSx0fImiNdG4AIvlAvDTBa/mFd4u2ySDUaQCPIy4kycLS1oYuLl39OSLHqhdBe/PCdtzvP8e04Jz/Nwu91gGAYej8euDOP9AwOv1+sYSaVSSCQSd2KxfUqERNlVkiAIIiU4QkqlEsrlMrLZLIrFIlQ1hUz2AIp6sK5KGslk8q+h/0OsBKnDIyjpNOKxOMQITbS7B0kUENwOwOdbf8r6KDYjIt1YzGWRowllWYZMp+xLISTkMEQpiEhkBxzHw+/3g2XZjWhDETsPt2FdjvWA4zi6maM1CNbPg2N5BPjA3ftNjYmVKpfLQ1UUZDIqXWdoOhH5goIjemExIQEpGoMQjSIUCtkDreb/QsLhMAr5AvUIsqQgGVfp4Uaxu+eDn/XYv9LWgy24XC5HSK1WQ7P5Gm9OmjhuPKEeo/nqKZrHL9BoPEe9XkelUkG1WnWEdC4v0OsN8GV+AXN8Av3jSyy/vsP3H7+wWpnUCsvl0jHS7XZxdnaOweADlsYNDEPDYmFC13VqQdf3Q66uOjh/f4nr8Slue8+gf34L3fiJhf7NcRNruKZpdiWdToemG2A+n0HXbmij23slspoYhmEfjWmaIMPhEKPRCJ/GY0yn15hMptTEsdlshn6/j1arhXa7jd8q+pKalcJ2dQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tasks microtasks\"\n        title=\"tasks microtasks\"\n        src=\"/blog/static/08b396c7fcd545e1bd2ccc198980df51/d868b/tasks-microtasks.png\"\n        srcset=\"/blog/static/08b396c7fcd545e1bd2ccc198980df51/e1650/tasks-microtasks.png 210w,\n/blog/static/08b396c7fcd545e1bd2ccc198980df51/8cae7/tasks-microtasks.png 420w,\n/blog/static/08b396c7fcd545e1bd2ccc198980df51/d868b/tasks-microtasks.png 681w\"\n        sizes=\"(max-width: 681px) 100vw, 681px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><strong>第一次 Task 执行：</strong></p>\n<ul>\n<li>将当前的 script 推入 Tasks 中</li>\n<li>执行第一段代码，输出<code class=\"language-text\">script start</code></li>\n<li>setTimout 回调推入 webapis 的定时栈中</li>\n<li>Promise 的第一个 then 回调推入 Microtasks</li>\n<li>执行最后一句输出<code class=\"language-text\">script end</code></li>\n<li><strong>检查 Microtasks 中是否有任务</strong></li>\n<li>执行推入的第一个 Promise 的 then 回调</li>\n<li>输出<code class=\"language-text\">promise1</code>，之后将第二个 then 回调推入 Microtasks</li>\n<li>检查 Microtasks 中是否有任务</li>\n<li>执行推入的第二个 Promise 的 then 回调</li>\n<li>输出<code class=\"language-text\">promise2</code></li>\n<li>第一个 Tasks 执行完毕，<strong>刷新 UI</strong></li>\n</ul>\n<p><strong>第二次 Task 执行：</strong></p>\n<ul>\n<li>webapis 根据定时将 setTimeout 回调推入 Tasks 中</li>\n<li>Event loop 从 Tasks 取出任务执行</li>\n<li>输出<code class=\"language-text\">setTimeout</code></li>\n<li><strong>检查 Microtasks 中没有任务</strong></li>\n<li>当前 Task 执行完毕，<strong>刷新 UI</strong></li>\n</ul>\n<h4 id=\"tasks-和-microtasks-所涉及的-api：\" style=\"position:relative;\"><a href=\"#tasks-%E5%92%8C-microtasks-%E6%89%80%E6%B6%89%E5%8F%8A%E7%9A%84-api%EF%BC%9A\" aria-label=\"tasks 和 microtasks 所涉及的 api： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tasks 和 microtasks 所涉及的 API：</h4>\n<ul>\n<li><strong>Tasks</strong>: setTimeout, setInterval, (setImmediate, I/O,) UI rendering</li>\n<li><strong>microtasks</strong>: (process.nextTick,) Promise, MutationObserver</li>\n</ul>\n<h4 id=\"需要注意的地方：\" style=\"position:relative;\"><a href=\"#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%9A\" aria-label=\"需要注意的地方： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>需要注意的地方：</h4>\n<ul>\n<li>microtasks 不是 webapis，他的优先级比 Tasks 高，每轮主流任务执行完毕都会检查 microtasks，检查完毕后这轮 Task 才结束</li>\n<li>micrtasks 为 js 逻辑的一部分，不涉及到 UI 等 web 功能，因此功能上应该和 setTimeout 等 webapis 作区分</li>\n<li><strong>每轮 Task 结束都会渲染 UI，为了防止 UI 卡死</strong></li>\n<li>setTimeout 由 webapis 管理，当定时时间到了，就推入 Tasks 中等待执行（不是立即执行）</li>\n<li>setTimeout 最短执行时间为 4ms，即使定时时间为 0</li>\n</ul>\n<h3 id=\"代码解读-2\" style=\"position:relative;\"><a href=\"#%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB-2\" aria-label=\"代码解读 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>代码解读 2</h3>\n<p>两个父子关系的 div 绑定 click 事件，根据回调输出 log。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 701px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.61904761904762%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA0ElEQVQoz5WRTQqDMBCFvf8lqnbVXEBxJegVVMS1fys1MVFUfG1SlFar0gfDkJfMl2FGq+satKGglKKqKrC2hfLo22uaBpwLLJpnGTOOpHHO0XWdCsYY+r5XWfotaxVUCIFpmjCO4wo7gmo4UVmW8H0fnufBdV3EcbzCDoHL5Tak8jwHIQSGbuBu3hEEwX/A7eOiKEAeBPpNh2mYCMPwGvh52M4nyzI4jgPbtmFZFqIwugYOw6AG/qvDrwW9ti/z9vMdMEkSpGm6gx0VnHUn9QTf9mr/pOmqAwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"事件测试\"\n        title=\"事件测试\"\n        src=\"/blog/static/edfa7d3104f0b66995eb8175c5f40fe9/3914f/js-click.png\"\n        srcset=\"/blog/static/edfa7d3104f0b66995eb8175c5f40fe9/e1650/js-click.png 210w,\n/blog/static/edfa7d3104f0b66995eb8175c5f40fe9/8cae7/js-click.png 420w,\n/blog/static/edfa7d3104f0b66995eb8175c5f40fe9/3914f/js-click.png 701w\"\n        sizes=\"(max-width: 701px) 100vw, 701px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">事件测试</figcaption>\n  </figure></p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>outer<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>inner<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Let's get hold of those elements</span>\n<span class=\"token keyword\">var</span> outer <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".outer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> inner <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".inner\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Let's listen for attribute changes on the</span>\n<span class=\"token comment\">// outer element</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mutate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>outer<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  attributes<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Here's a click listener…</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">onClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"timeout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  outer<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data-random\"</span><span class=\"token punctuation\">,</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// …which we'll attach to both elements</span>\ninner<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> onClick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nouter<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> onClick<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>点击内部 div 后的执行过程如下：</p>\n<p><strong>脚本执行：</strong></p>\n<ul>\n<li>将 script 推如 Tasks，因为 stack 空闲，执行 script 脚本，完成事件绑定</li>\n</ul>\n<p><strong>用户点击：</strong></p>\n<ul>\n<li>用户点击 inner div</li>\n<li>因为是在冒泡阶段触发，因此 inner 元素的 click 事件先触发，回调推入 Tasks 中</li>\n<li>冒泡向上，outer 元素的 click 事件触发，回调推入 Tasks 中</li>\n<li>当前没有 microtasks，Tasks 执行完毕，UI 更新</li>\n</ul>\n<p><strong>第一个事件回调（inner）：</strong></p>\n<ul>\n<li>从 Tasks 中取出任务（inner 元素的事件回调）</li>\n<li>打印<code class=\"language-text\">click</code>，</li>\n<li>setTimout 回调推入 webapis 的定时栈中</li>\n<li>将 Promise 的第一个 then 推入 microtasks 中</li>\n<li>修改 outer 的属性触发监听，将 MutationObserver 推入 microtasks</li>\n<li>检查 microtasks 中任务并执行</li>\n<li>打印 <code class=\"language-text\">promise</code>和<code class=\"language-text\">mutate</code></li>\n<li>第一个回调执行完毕，执行第二个 click 事件回调</li>\n</ul>\n<p><strong>第二个事件回调（outer）：</strong></p>\n<ul>\n<li>从 Tasks 中取出任务（outer 元素的事件回调）</li>\n<li>打印<code class=\"language-text\">click</code>，</li>\n<li>setTimout 回调推入 webapis 的定时栈中</li>\n<li>将 Promise 的第一个 then 推入 microtasks 中</li>\n<li>修改 outer 的属性触发监听，将 MutationObserver 推入 microtasks</li>\n<li>检查 microtasks 中任务并执行</li>\n<li>打印 <code class=\"language-text\">promise</code>和<code class=\"language-text\">mutate</code></li>\n<li>第二个回调执行完毕</li>\n</ul>\n<p><strong>setTimeout 回调：</strong></p>\n<ul>\n<li>上两个 Tasks 执行完毕，检查 webapis 是否有定时任务</li>\n<li>将 inner 中的 setTimeout 推入 Tasks</li>\n<li>执行回调输出<code class=\"language-text\">timeout</code></li>\n<li>检查 webapis 是否有定时任务</li>\n<li>将 outer 中的 setTimeout 推入 Tasks</li>\n<li>执行回调输出<code class=\"language-text\">timeout</code></li>\n</ul>\n<h4 id=\"需要注意的地方\" style=\"position:relative;\"><a href=\"#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9\" aria-label=\"需要注意的地方 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>需要注意的地方</h4>\n<ul>\n<li>注意冒泡过程添加 Tasks 的顺序</li>\n<li>Tasks 中的任务遵循先进先出的规则</li>\n<li>microtasks 中的任务在每次 Tasks 时都必须检查并执行完毕</li>\n</ul>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\" target=\"_target\" rel=\"nofollow\">Tasks, microtasks, queues and schedules</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=8aGhZQkoFbQ\" target=\"_target\" rel=\"nofollow\">Philip Roberts: What the heck is the event loop anyway? | JSConf EU 2014</a></li>\n</ul>","timeToRead":6,"wordCount":{"paragraphs":97,"sentences":98,"words":434},"fields":{"slug":"/js-shi-jian-ji-zhi/","relativePath":"2018/2018-03-24---js-shi-jian-ji-zhi/index.md"},"excerpt":"这里所指都是在浏览器环境中，而不是 Nodejs 环境。 JS 异步机制 关于 JS 简要的运行机制及事件队列等知识强烈希望能翻墙看下这个视频：地址。 这里有个很重要的图需要深刻理解：  Chrome 中的 V…","frontmatter":{"title":"JS事件机制及Tasks和microtasks的区别","date":"24 Mar 2018","tags":["JavaScript"],"cover":"","comments":true,"author":"烈风裘"}},"prevPost":{"html":"<h3 id=\"1-什么是-ssr？什么情况下需要使用-ssr？\" style=\"position:relative;\"><a href=\"#1-%E4%BB%80%E4%B9%88%E6%98%AF-ssr%EF%BC%9F%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8-ssr%EF%BC%9F\" aria-label=\"1 什么是 ssr？什么情况下需要使用 ssr？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 什么是 SSR？什么情况下需要使用 SSR？</h3>\n<p>SSR（Server Side Render）<strong>服务端渲染</strong>，这里主要是为了解决 SPA 应用首屏<mark>加载缓慢、白屏</mark>的问题。用户在访问 SPA 应用时，服务端（Nodejs）先获取页面需要的数据<strong>生成 HTML 字符串</strong>传递给客户端用于首屏显示，随后再加载其余资源进行<strong>渲染结果比对</strong>和<strong>后渲染</strong>流程。</p>\n<h3 id=\"2-传统-spa-渲染过程和-ssr-渲染过程有何不同？\" style=\"position:relative;\"><a href=\"#2-%E4%BC%A0%E7%BB%9F-spa-%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E5%92%8C-ssr-%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F\" aria-label=\"2 传统 spa 渲染过程和 ssr 渲染过程有何不同？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 传统 SPA 渲染过程和 SSR 渲染过程有何不同？</h3>\n<p>下面是两种方式的时序图：</p>\n<p><strong>客户端渲染</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.19047619047618%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsSAAALEgHS3X78AAADPElEQVQ4y5VU3UtTYRh/zznbmWem5jK3aWu7GFksbE1YZsIoCcI79x8EI0SSwotCL2qUMIJpCAl60Y1ML/VCRBRD0anzI+dExQvF7w8GgthFedP6Pcez6T4KeuDZ++45z/t7n4/f8zIGaW1tpYX5/X6ho6ND6urqktra2tRMkZ6eHr6/v186OTnJisViUl1dHU/25uZmvrOzU5qenpba29vFuD/b2dkRaD06OqqdnZ09GxkZOdvd3Q3Evy8uLrpXV1d/z83NRZeXl38tLS25yb61tfUMfj/C4fDPw8PDcZvNJuOw7e1t+caNjQ03PiwcHByENzc3/XHAtbU1VzQajezt7U3u7+8vQKrJjksewh5CIN8pgKamposokQq7JBz95OXliRqNJhtbNUuRFH85oL6+vvSPlZWVvFarzVar1QRkgjqg5qKiouuo8YNU4MbGRs5sNquSjDMzM4m9wWBQAeyaIAgG/L0NLSHgqqqqQtTOV1FRIR/2er2yf1lZGVdQUCBnYDKZzkEmJyc5dFKYn5/n0UGV3W4nhyzoVcocegWi9ng8uaIocilB0v+LCAmMpYs2JycnF6sRqofmpjqoVOcYDoeDczqdcjNKSkoSoE9GR0e/Dg8Pf0b6HnDxOcwiapOPlbSYMgKIQbmEImdjY2Mso4yPj7sA9mVwcPAjePYpEom8Jbvb7dZStFRa6C2lSVboTZRAokBramruDQwMyLxcX1/nWDAYTEoZvHKA+e9p7/P5RA6i1IgadUcBZ+i6hlb4WuIBgC1coo4TExNyp0BoF4j+mvZIuQiLhbZQHUWmlCC1KWJa2pgQmZyYkkcA/0COiMKi0OZGaWlpMS72xv0xu5cBhQRQb28v1VCFeRWVMXStrKy8ob3FYqEI7VQ/Ij+a8NRoNMqH6+vr5fOoJYeJkrPDQKQ36Pj4+H4oFHpHvlartRCrTUn5glPJB5N5iAjz0ZiXKO4rDP+LqampWhA8SMRuaGgQeJ4ngovd3d2svLxcEz+n0+kyAw4NDd3FkxVDVLHT09MYnqRvAKzO8ACwTI9EGmAgENAiwsdEbtSxqqWlxanwLZMIf7Hz7B8i6PV6GVCSJHos2P/IHw3RRzPEVYZaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SPA\"\n        title=\"SPA\"\n        src=\"/blog/static/99ef46391c0a4a25b884d71946a2b44e/f88f5/SPA.png\"\n        srcset=\"/blog/static/99ef46391c0a4a25b884d71946a2b44e/e1650/SPA.png 210w,\n/blog/static/99ef46391c0a4a25b884d71946a2b44e/8cae7/SPA.png 420w,\n/blog/static/99ef46391c0a4a25b884d71946a2b44e/f88f5/SPA.png 840w,\n/blog/static/99ef46391c0a4a25b884d71946a2b44e/9f657/SPA.png 948w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><strong>服务端渲染</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.23809523809524%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACqUlEQVQ4y5VUT0iaYRh/X+3z37SaSzHbOsQ0i+Fau8koiEYgeNlhCLtvjLwVg1DqsGOXDXQn12GnWp5WJP5J0/6pFGIeKqJAQaRT0qWL4H7Pt89hkYw98PC+7/M+3/P8fr/34WOrq6usXq8zsnw+bwuHw1P7+/vDdD49PVVub2+PpVKpiWKx2EMx3PWn0+mJnZ2diYODg0cUw93LbDb7GusAi8VirNFoyOiiUqkEq9Vq4+Li4iedETdgf1UqlRrlcvktxc7Pzz9JZ8p7Q7HLy8tsrVaj2BcWCAToQxEhOhqPj4+fr6ysDOCoN5vNxvX1dVsul7MVCoVOysG+G02fIncIqJqxfpztGxsbvaxpy8vLrMUEjUbTh7V7enraiqIO7OV6vX4Iq8lut/c6nU4VJe7t7fHWD9nS0hK7ublhEkXmcrmEJmKys7OzEWjzgfYGg2GUkEOm8cPDQ7ukKb++vuaTk5NCMBi8XVwyOZzPzc2JuoLqs0wm8x5bGRDasFrgCsq5810Ha2NC6+Hk5GRkd3f3G+0XFhaEDpjUVHZvwUQiweLxuDwUChFVrlaruxA2KhSKJ1h75ufnR0D7lSSJiEqn03FBEOQiHbn8nwjFS865AIod9yBhEt2/lba2tpjD4fjDLJlMKjY3Nz9j/Y7B/uh2uwe1Wu0grsxNnSwWCxVWwx/AVU2d73bxeDwiZdXa2tovFC3gNX+g2zuMhBH3SowOia8BWpKhH04yPIY/pOKgTk2E2dlZM15+rB1doqiF9jrSkApLqGiIrfAuKUdlMpkIOff7/d0A9EL8GvOkjEajX/GSIYyHNxKJTGGmCGEnkPW1vCiXJoC3NL5lMzMzjF5Yhmkfhn6jR0dH1sXFxXGfz6e85xFYuxh+IMzr9craUda3jABn/2m/ARDgFqjQKFJ8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SSR\"\n        title=\"SSR\"\n        src=\"/blog/static/a852d8c00f308f274cb618361a9adddc/f88f5/SSR.png\"\n        srcset=\"/blog/static/a852d8c00f308f274cb618361a9adddc/e1650/SSR.png 210w,\n/blog/static/a852d8c00f308f274cb618361a9adddc/8cae7/SSR.png 420w,\n/blog/static/a852d8c00f308f274cb618361a9adddc/f88f5/SSR.png 840w,\n/blog/static/a852d8c00f308f274cb618361a9adddc/13e46/SSR.png 1252w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><strong>注意：</strong></p>\n<ul>\n<li>SSR 可以在<code class=\"language-text\">window.onload</code> 事件前（css 已在页面中，js 等资源还未加载完）就能显示页面内容</li>\n<li>\n<p>对于同一个组件，服务端通过执行部分钩子代码完成“可视”部分渲染，不同框架不太一样</p>\n<p>  \t- React：<code class=\"language-text\">componentWillMount/render</code>\n- Vue：<code class=\"language-text\">beforeCreate/create</code></p>\n</li>\n<li>针对 SSR，为了保证组件的完整生命周期及事件处理，客户端需要再次渲染（包括和客户端已有界面数据的比对校验）</li>\n</ul>\n<h3 id=\"3-支持-ssr-的后端服务有哪些？\" style=\"position:relative;\"><a href=\"#3-%E6%94%AF%E6%8C%81-ssr-%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F\" aria-label=\"3 支持 ssr 的后端服务有哪些？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 支持 SSR 的后端服务有哪些？</h3>\n<p>只有 Nodejs。</p>\n<h3 id=\"4-nodejs-端和客户端为什么会有两个入口？\" style=\"position:relative;\"><a href=\"#4-nodejs-%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E4%B8%A4%E4%B8%AA%E5%85%A5%E5%8F%A3%EF%BC%9F\" aria-label=\"4 nodejs 端和客户端为什么会有两个入口？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Nodejs 端和客户端为什么会有两个入口？</h3>\n<p>这里指的是<code class=\"language-text\">server.js/client.js</code>两个入口文件。</p>\n<ul>\n<li>服务端需要开启服务，并通过路由导航到正确的页面</li>\n<li>客户端就是完整的基于 router 的 SPA</li>\n<li>两个通过 Router 连接到公共代码</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 836px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.71428571428571%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACVElEQVQ4y5WTTYhSURTH73t+TEY1UaO0aPpgxs+xwk0igQ0RQ9kqcjEoidYmps2QlC5aCa7VjeIuaCUE6kYUnEUoDuKAZuqYiPj9AWouFBQXdu7jabiw8MDhnfd/95z3O+feixCY0WjED6RWq5Hdbmem02l2oVBg22w2lkajIfA3q9XKPDs7Y1cqFbbL5WIZDAZKN5vNSCwWo4VxuVwUDodJHOdyubvtdvtHo9GIQWK03+//zOfzD7Va7YVutxtpNpuJcrn8HeJCqVR6iXPOz88ZuODcl2wymWxAoedAchyLxT5Go9HXwWDwmk6nI0B/kslk3kciEfPp6embVCp1A60ykUi0pVQqb0J4EWjvjUajGTZIejxfY7FYrgyHw99Yhx8egUTq9frrAoHgMpBtgnPACSQUCgn8olKpNnAiUNyqVqtfWq3WV5ijBGtQgwgEAldhHI5arfYtHo8/BXlLLpfflkgk25CPnQfFGYjP568CZ4HjwZP0OxucuWrx0vz29vbQ/v4+FXs8HkzEwHE2m90G4g/FYvHdycnJJk1LwkZQO3xwcIB2dnZwl3+LASblsBBxOBxKgwIUSb1efzWjLZFI3McatEuaTCbE4/GQQqFAUqkUQdsU4e7u7jK2TCajnkBDEcBu8vx+/9tQKHTo8/kuYc3r9S6t/a85nU6qLZrwcDqdtuA4/QLqR7RGonXM7XYvZtjpdI5wu+PxeAbn8BnW4HCvVxCu1aIg3Jjj+QyB8AVNyFiroMPhQHCwCfpaPRgMBp97vd6nZDJ5B2twFYl/5f8Bal00/MafpbkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"(two-entry\"\n        title=\"(two-entry\"\n        src=\"/blog/static/df3040e0fd9a8f3d5a099484f1525230/d356c/two-entry.png\"\n        srcset=\"/blog/static/df3040e0fd9a8f3d5a099484f1525230/e1650/two-entry.png 210w,\n/blog/static/df3040e0fd9a8f3d5a099484f1525230/8cae7/two-entry.png 420w,\n/blog/static/df3040e0fd9a8f3d5a099484f1525230/d356c/two-entry.png 836w\"\n        sizes=\"(max-width: 836px) 100vw, 836px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">(two-entry</figcaption>\n  </figure></p>\n<h3 id=\"5-两种方式的组件生命周期有何不等\" style=\"position:relative;\"><a href=\"#5-%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E7%9A%84%E7%BB%84%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%9C%89%E4%BD%95%E4%B8%8D%E7%AD%89\" aria-label=\"5 两种方式的组件生命周期有何不等 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 两种方式的组件生命周期有何不等?</h3>\n<ul>\n<li>服务端：componentWillMount( node 端 ) -> render( node 端 )</li>\n<li>客户端：SPA 的方式</li>\n</ul>\n<h3 id=\"6-拉取数据后如何处理呢？\" style=\"position:relative;\"><a href=\"#6-%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE%E5%90%8E%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%91%A2%EF%BC%9F\" aria-label=\"6 拉取数据后如何处理呢？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. 拉取数据后如何处理呢？</h3>\n<ul>\n<li>服务端获取数据组装 HTML 页面</li>\n<li>将组装页面用到的数据嵌入 HTML 中一同发送</li>\n<li><strong>客户端提取 HTML 中数据校验服务端 HTML 是否正确</strong>，并初始化客户端 Store</li>\n</ul>\n<h3 id=\"7-上一步中，校验是如何进行的？\" style=\"position:relative;\"><a href=\"#7-%E4%B8%8A%E4%B8%80%E6%AD%A5%E4%B8%AD%EF%BC%8C%E6%A0%A1%E9%AA%8C%E6%98%AF%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E7%9A%84%EF%BC%9F\" aria-label=\"7 上一步中，校验是如何进行的？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. 上一步中，校验是如何进行的？</h3>\n<p><code class=\"language-text\">ReactDOMServer.renderToString</code> 返回的 HTML 字符串带有自定义属性，例如：<code class=\"language-text\">data-reactid</code>、<code class=\"language-text\">data-react-checksum</code>。客户端从 HTML 中获取页面数据然后渲染计算得到的 checksum 与页面中的 checksum 比对，如果不一致则从新渲染，出现闪屏现象。</p>\n<h3 id=\"8-生成两个入口的-webpack-配置如何不同？\" style=\"position:relative;\"><a href=\"#8-%E7%94%9F%E6%88%90%E4%B8%A4%E4%B8%AA%E5%85%A5%E5%8F%A3%E7%9A%84-webpack-%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F\" aria-label=\"8 生成两个入口的 webpack 配置如何不同？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8. 生成两个入口的 webpack 配置如何不同？</h3>\n<ul>\n<li>前端：JSX+ES6/7 -> es5</li>\n<li>后端：JSX+ES6/7 -> nodejs</li>\n</ul>\n<h3 id=\"9-服务端如何知道-path-对应的页面应该使用哪个接口数据？\" style=\"position:relative;\"><a href=\"#9-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93-path-%E5%AF%B9%E5%BA%94%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%BA%94%E8%AF%A5%E4%BD%BF%E7%94%A8%E5%93%AA%E4%B8%AA%E6%8E%A5%E5%8F%A3%E6%95%B0%E6%8D%AE%EF%BC%9F\" aria-label=\"9 服务端如何知道 path 对应的页面应该使用哪个接口数据？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>9. 服务端如何知道 path 对应的页面应该使用哪个接口数据？</h3>\n<p>path -> match/RouterContext -> async 获取数据 -> render 组件 -> send</p>\n<h3 id=\"10-客户端和服务端渲染不一致该如何排查？\" style=\"position:relative;\"><a href=\"#10-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E4%B8%8D%E4%B8%80%E8%87%B4%E8%AF%A5%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5%EF%BC%9F\" aria-label=\"10 客户端和服务端渲染不一致该如何排查？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10. 客户端和服务端渲染不一致该如何排查？</h3>\n<p>服务端只执行<code class=\"language-text\">componentWillMount/render</code>两个钩子，因此不要在这里执行会存在差异的代码，比如平台判断等。</p>\n<h3 id=\"11-掘金主页加载时的-ssr-示例\" style=\"position:relative;\"><a href=\"#11-%E6%8E%98%E9%87%91%E4%B8%BB%E9%A1%B5%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84-ssr-%E7%A4%BA%E4%BE%8B\" aria-label=\"11 掘金主页加载时的 ssr 示例 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>11. 掘金主页加载时的 SSR 示例</h3>\n<p>骨架 Nuxt + 异步数据渲染</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 840px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAFA3PEY8MlBGQUZaVVBfeMiCeG5uePWvuZHI////////////////////////////////////////////////////2wBDAVVaWnhpeOuCguv/////////////////////////////////////////////////////////////////////////wgARCAALABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAL/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAFMikj/xAAXEAADAQAAAAAAAAAAAAAAAAACEBEg/9oACAEBAAEFAiUx/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAgIDAAAAAAAAAAAAAAAAABEBEEFRYf/aAAgBAQABPyFXAuUwOd1//9oADAMBAAIAAwAAABAQD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQABBQADAAAAAAAAAAAAAAEAETFBUWFxgZH/2gAIAQEAAT8QIpBaxBZo9SjYeZt2dn2KuWf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SSR-juejin\"\n        title=\"SSR-juejin\"\n        src=\"/blog/static/f4ba33008c16b3914bd880d93a7c13bd/17354/SSR-juejin.jpg\"\n        srcset=\"/blog/static/f4ba33008c16b3914bd880d93a7c13bd/58c35/SSR-juejin.jpg 210w,\n/blog/static/f4ba33008c16b3914bd880d93a7c13bd/0d24e/SSR-juejin.jpg 420w,\n/blog/static/f4ba33008c16b3914bd880d93a7c13bd/17354/SSR-juejin.jpg 840w,\n/blog/static/f4ba33008c16b3914bd880d93a7c13bd/61048/SSR-juejin.jpg 1024w\"\n        sizes=\"(max-width: 840px) 100vw, 840px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">SSR-juejin</figcaption>\n  </figure></p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://www.cnblogs.com/BestMePeng/p/react_ssr.html\" target=\"_target\" rel=\"nofollow\">React 服务端渲染总结</a></li>\n<li><a href=\"https://juejin.im/post/598aabe96fb9a03c335a8dde\" target=\"_target\" rel=\"nofollow\">美团点评点餐 Nuxt.js 实战</a></li>\n</ul>","timeToRead":6,"wordCount":{"paragraphs":40,"sentences":40,"words":161},"fields":{"slug":"/ssr-xiang-guan-wen-da/","relativePath":"2018/2018-03-29---ssr-xiang-guan-wen-da/index.md"},"excerpt":"1. 什么是 SSR？什么情况下需要使用 SSR？ SSR（Server Side Render）服务端渲染，这里主要是为了解决 SPA 应用首屏加载缓慢、白屏的问题。用户在访问 SPA 应用时，服务端（Nodejs…","frontmatter":{"title":"SSR相关","date":"29 Mar 2018","tags":["总结"],"cover":"","comments":true,"author":"烈风裘"}}},"pageContext":{"curr":"/js-gao-cheng-wen-da/","prev":"/ssr-xiang-guan-wen-da/","next":"/js-shi-jian-ji-zhi/"}},"staticQueryHashes":["3240721340","63159454"]}